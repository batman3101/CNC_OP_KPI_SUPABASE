# CNC 작업자 KPI 관리 시스템

## 프로젝트 개요
CNC 작업자들의 생산성과 품질을 관리하기 위한 웹 기반 KPI 관리 시스템입니다. 
Streamlit을 사용하여 개발되었으며, Supabase를 통해 데이터를 저장하고 관리합니다.
이 시스템은 생산 현장에서 작업자들의 성과를 실시간으로 추적하고, 관리자가 데이터 기반 의사결정을 할 수 있도록 지원합니다.

## 주요 기능

### 1. 사용자 관리
- 관리자/일반 사용자 권한 구분
- 관리자/일반 사용자 화면 구성 구분
- 로그인 시스템
- 사용자 등록/삭제 기능
- 비밀번호 암호화 저장
- 사용자 프로필 관리

### 2. 생산 실적 관리
- 일일 생산 실적 입력 (Supabase 데이터베이스에서 동기화하여 드롭다운 메뉴로 선택)
- 작업자별 실적 조회
- 모델차수 선택
- 실적 데이터 수정 및 삭제
- 중복 데이터 관리
- 실시간 데이터 동기화
- 대용량 데이터 효율적 표시 (페이지네이션 기능)
- 필터링, 정렬, 그룹화 기능

### 3. KPI 대시보드
- 종합 대시보드
  - 전체 생산목표달성률
  - 평균 불량률
  - 평균 작업효율
  - 월별 생산 현황 차트
  - 불량률 트렌드 그래프 (주간, 월간, 연간 선택 시 표시)
  - 라인별 성능 비교
  - 작업자별 성과 비교

### 4. 리포트 기능
- 일간 리포트
  - 일별 KPI 지표
  - 작업자별 일간 실적 집계
  - 작업자별 일간 생산량 차트
  - 일간 불량률 분석
  - 필터링 및 페이지네이션 기능
- 주간 리포트
  - 주간 KPI 지표
  - 작업자별 주간 실적 집계
  - 작업자별 일간 생산량 차트
  - 주간 불량률 트렌드
- 월간 리포트
  - 월간 KPI 지표
  - 작업자별 월간 실적 집계
  - 작업자별 일간 생산량 차트
  - 월간 불량률 트렌드
- 연간 리포트
  - 연간 KPI 지표
  - 작업자별 연간 실적 집계
  - 작업자별 일간 생산량 차트
  - 연간 불량률 트렌드
- 전체 작업자중 우수,최저 KPI 확인 (드롭다운 메뉴로 작업자 구분)
  - 일간 리포트
  - 주간 리포트
  - 월간 리포트
  - 연간 리포트

### 5. 데이터 백업 및 동기화
- Supabase 데이터베이스 연동
- 데이터 자동 백업
- 데이터 동기화
- 캐시 관리 시스템
- 양방향 데이터 동기화 (앱 ↔ 데이터베이스)
- 페이지네이션을 통한 대용량 데이터 처리 (1000개 단위)

### 6. 최근 추가된 기능
- **데이터 그리드 개선**: AgGrid를 통한 강력한 데이터 그리드 기능 제공
- **페이지네이션**: 대용량 데이터를 효율적으로 표시하기 위한 페이지네이션 구현
- **필터링 및 정렬 기능**: 사용자가 원하는 데이터를 쉽게 찾을 수 있는 필터링 및 정렬 기능
- **데이터 그룹화**: 작업자, 날짜, 라인별 데이터 그룹화 기능
- **디버그 메시지 관리**: 콘솔 로깅을 통한 디버그 메시지 관리 (화면에 표시되지 않음)
- **자동 필드명 감지**: 다양한 데이터 형식에 자동으로 대응하는 필드명 감지 기능
- **데이터 일괄 로드**: Supabase에서 데이터 일괄 로드 개선 (페이지네이션 적용)
- **UI/UX 개선**: 직관적인 사용자 인터페이스와 사용자 경험 개선

## 기술 스택
- **Python 3.9+**: 주요 프로그래밍 언어
- **Streamlit 1.24.0+**: 웹 애플리케이션 프레임워크
- **Supabase 2.0.0+**: 백엔드 데이터베이스 및 API
- **Pandas 1.5.3+**: 데이터 처리 및 분석
- **NumPy 1.24.3+**: 수치 계산
- **Plotly 5.14.1+**: 데이터 시각화
- **streamlit-aggrid 0.3.4+**: 고급 데이터 그리드 컴포넌트
- **bcrypt 4.0.1+**: 비밀번호 암호화
- **python-dotenv 1.0.0+**: 환경 변수 관리
- **Git**: 버전 관리 시스템

## 데이터 구조

### 1. 작업자 정보 (Workers 테이블)
- id: 자동 생성 ID (primary key)
- 사번: 작업자 사번 (unique)
- 이름: 작업자 이름
- 부서: 소속 부서
- 라인번호: 작업 라인

### 2. 생산 실적 (Production 테이블)
- id: 자동 생성 ID (primary key)
- 날짜: 생산 날짜
- 작업자: 작업자 사번
- 라인번호: 생산 라인
- 모델차수: 생산 모델
- 목표수량: 일일 목표 생산량
- 생산수량: 실제 생산량
- 불량수량: 불량품 수량
- 특이사항: 비고

### 3. 모델 정보 (Models 테이블)
- id: 자동 생성 ID (primary key)
- MODEL: 모델명
- PROCESS: 공정명

### 4. 사용자 정보 (Users 테이블)
- id: 자동 생성 ID (primary key)
- email: 이메일 (unique)
- password: 비밀번호 (암호화)
- name: 이름
- role: 역할 (admin/user)

## 폴더 구조
```
CNC_OP_KPI_SUPABASE/
│
├── app.py                # 메인 애플리케이션 파일, Streamlit 서버를 실행
├── requirements.txt      # 프로젝트 의존성 패키지 목록
├── .env                  # 환경 변수 파일 (Supabase 연결 정보)
├── utils/                # 유틸리티 함수 및 클래스
│   ├── supabase_db.py    # Supabase와의 데이터 연결 및 처리
│   ├── local_storage.py  # 로컬 데이터 스토리지 처리
│   └── common.py         # 공통 유틸리티 함수
└── pages/                # 각 페이지별 Python 파일
    ├── admin_management.py  # 관리자 및 사용자 관리 페이지
    ├── dashboard.py         # 대시보드 페이지, 전체 생산성과 KPI를 시각화
    ├── daily_report.py      # 일간 리포트 페이지
    ├── weekly_report.py     # 주간 리포트 페이지
    ├── monthly_report.py    # 월간 리포트 페이지
    ├── yearly_report.py     # 연간 리포트 페이지
    ├── production.py        # 생산 실적 관리 페이지
    ├── worker_management.py # 작업자 관리 페이지
    ├── model_management.py  # 모델 관리 페이지
    └── data_sync.py         # 데이터 동기화 페이지
```

## 구현된 메뉴
### 관리자 메뉴
- **관리자 및 사용자 관리**: 사용자 계정 생성, 수정 및 삭제 기능을 제공합니다.
- **작업자 등록 및 관리**: 작업자 정보를 등록하고 관리할 수 있는 기능을 제공합니다.
- **생산 모델 관리**: 다양한 생산 모델을 등록하고 관리할 수 있습니다.
- **생산 실적 관리**: 생산 실적 데이터를 입력하고 수정할 수 있는 기능을 제공합니다.
  - 필터링 및 검색 기능
  - 데이터 수정 및 삭제
  - 페이지네이션을 통한 대용량 데이터 관리

### 리포트 메뉴
- **종합 대시보드**: 전체 생산성과 KPI를 시각화하여 한눈에 볼 수 있는 대시보드입니다.
  - 주요 KPI 지표 (생산목표달성률, 불량률, 작업효율)
  - 기간별 생산 현황 차트
  - 불량률 트렌드 그래프 (주간, 월간, 연간 선택 시)
  - 라인별 성능 비교
  - 작업자별 성과 비교
- **일간 리포트**: 특정 날짜의 생산 실적을 조회하고 분석할 수 있는 페이지입니다.
  - 데이터 페이지네이션 (100개 단위)
  - 필터링 및 정렬 기능
  - 작업자별 생산량 그래프
  - 작업자별 KPI 비교
- **주간 리포트**: 주 단위로 생산 실적을 분석할 수 있는 페이지입니다.
- **월간 리포트**: 월 단위로 생산 실적을 분석할 수 있는 페이지입니다.
- **연간 리포트**: 연 단위로 생산 실적을 분석할 수 있는 페이지입니다.

### 데이터 관리
- **데이터 동기화**: Supabase와의 실시간 데이터 동기화 기능을 제공합니다. 이를 통해 데이터의 일관성을 유지할 수 있습니다.
  - 앱에서 Supabase로 데이터 내보내기
  - Supabase에서 앱으로 데이터 가져오기
  - 데이터 백업 및 복원
  - Supabase 연결 설정 관리

## 설치 및 실행 방법
1. 필요한 패키지 설치:
```bash
pip install -r requirements.txt
```

2. 환경 변수 설정:
- `.env` 파일 생성 및 Supabase 연결 정보 설정
```
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_key
```

3. 애플리케이션 실행:
```bash
streamlit run app.py
```

## 보안 기능
- 비밀번호 bcrypt 암호화
- 관리자/사용자 권한 구분
- Supabase 인증
- 세션 관리
- 접근 제어

## 데이터 백업 및 캐시 관리
- Supabase 자동 동기화
- 로컬 캐시 기능 (60초 타임아웃)
- 데이터 변경 시 자동 캐시 무효화
- 양방향 데이터 동기화 (앱 ↔ 데이터베이스)
- 데이터 일관성 유지
- 페이지네이션을 통한 대용량 데이터 처리

## 사용자 인터페이스
- 반응형 웹 디자인
- 직관적인 네비게이션
- 실시간 데이터 시각화
- 사용자 친화적 입력 폼
- KPI 카드 및 대시보드
- 필터링 및 정렬 기능
- 데이터 그룹화 및 집계 기능
- 명확한 데이터 표현 (모든 KPI 수치에 단위 표시)
- 콘솔 로깅을 통한 디버그 메시지 관리 (화면에 표시되지 않음)

## 성능 최적화
- 페이지네이션을 통한 데이터 로드 최적화
- 자동 필드명 감지로 다양한 데이터 형식 지원
- 필터링 로직 개선으로 대용량 데이터 처리 성능 향상
- 콘솔 로깅을 통한 UI 간소화
- 데이터 캐싱으로 빠른 응답 시간 제공

## Supabase 데이터베이스 설정

이 프로젝트는 Supabase를 데이터베이스로 사용합니다.

### 설정 방법

1. Supabase 계정 생성 및 프로젝트 생성
   - [Supabase](https://supabase.com/)에서 계정을 생성하고 새 프로젝트를 생성합니다.
   - 프로젝트 생성 후 URL과 API Key(anon public)를 복사합니다.

2. 환경 변수 설정
   - `.env` 파일을 생성하고 Supabase URL과 API Key를 입력합니다.
   ```
   SUPABASE_URL=your_supabase_url
   SUPABASE_KEY=your_supabase_key
   ```
   - 또는 애플리케이션 실행 후 "데이터 동기화" 메뉴에서 설정할 수 있습니다.

3. 데이터베이스 테이블 생성
   - Supabase 대시보드에서 다음 테이블을 생성합니다:
     - `Users`: 사용자 정보 저장
     - `Workers`: 작업자 정보 저장
     - `Production`: 생산 실적 정보 저장
     - `Models`: 모델 정보 저장

4. 테이블 구조 설정
   - `Users` 테이블:
     - id (int8, primary key)
     - email (text, unique)
     - password (text)
     - name (text)
     - role (text)
   
   - `Workers` 테이블:
     - id (int8, primary key)
     - 사번 (text, unique)
     - 이름 (text)
     - 부서 (text)
     - 라인번호 (text)
   
   - `Production` 테이블:
     - id (int8, primary key)
     - 날짜 (date)
     - 작업자 (text)
     - 라인번호 (text)
     - 모델차수 (text)
     - 목표수량 (int4)
     - 생산수량 (int4)
     - 불량수량 (int4)
     - 특이사항 (text)
   
   - `Models` 테이블:
     - id (int8, primary key)
     - MODEL (text)
     - PROCESS (text)

5. 권한 설정
   - 각 테이블에 대한 RLS(Row Level Security) 정책을 설정하여 보안을 강화할 수 있습니다.
   - 기본적으로 모든 테이블에 대해 인증된 사용자만 접근할 수 있도록 설정하는 것이 좋습니다.

### 문제 해결

#### Supabase 연결 문제
- Supabase URL과 API Key가 올바르게 설정되었는지 확인합니다.
- 네트워크 연결 상태를 확인합니다.
- Supabase 프로젝트가 활성화되어 있는지 확인합니다.
- 환경 변수가 올바르게 로드되었는지 확인합니다.

#### 테이블 조회 오류
- 테이블 이름이 대소문자를 구분하므로 정확한 테이블 이름을 사용해야 합니다.
- 테이블이 존재하는지 Supabase 대시보드에서 확인합니다.
- 테이블 권한 설정이 올바른지 확인합니다.
- 필드 이름이 코드와 일치하는지 확인합니다.

#### 데이터 동기화 문제
- 캐시 타임아웃 설정을 확인합니다 (기본값: 60초).
- 데이터 변경 후 캐시가 무효화되었는지 확인합니다.
- 네트워크 연결 상태를 확인합니다.
- Supabase 서버 상태를 확인합니다.

## 최근 업데이트
- 모든 리포트의 KPI 및 통계 항목에 % 기호 추가로 가독성 개선
- 연간, 월간, 주간, 일간 리포트의 작업효율, 생산목표달성률, 불량률 표시 방식 일관화
- 로그인 화면 개선: 폼 구조에서 일반 입력 필드와 버튼으로 변경하여 안정성 향상
- 데이터 관리 페이지 오류 수정: form_submit_button 및 expander 컴포넌트의 key 매개변수 관련 오류 해결
- 불량률 트렌드 그래프 추가 (주간, 월간, 연간 리포트에 적용)
- 작업자 정보 수정 시 양방향 동기화 개선
- 생산 실적 데이터 수정 및 삭제 기능 개선
- 캐시 관리 시스템 최적화 (60초 타임아웃)
- 데이터 로딩 방식 개선으로 양방향 동기화 강화

## 연락처
- **이메일**: zetooo1972@gmail.com
- **GitHub**: [프로젝트 저장소 링크]